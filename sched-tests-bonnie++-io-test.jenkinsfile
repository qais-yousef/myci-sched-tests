pipeline {
	agent { label params.NODE }

	parameters {
		string(name: 'NODE', defaultValue: '', description: 'The DUT to run on. Must be Linux based DUT.')
		string(name: 'DESCRIPTION', defaultValue: '', description: 'Describe your experiment so that we have a meaningful name for this run to return to')
	}

	stages {
		stage('Verify') {
			steps {
				set_description()
				verify_linux()
				verify_params()
			}
		}
		stage('Bonnie++') {
			steps {
				start_perfetto("bonnie++")
				run_bonnie()
				stop_perfetto()
			}
		}
		stage('Generate Result') {
			steps {
				plot_frequency()
			}
		}
		stage('Archive') {
			steps {
				archiveArtifacts artifacts: '*.txt', followSymlinks: false
				archiveArtifacts artifacts: '*.png', followSymlinks: false
				archiveArtifacts artifacts: '*.perfetto-trace', followSymlinks: false, allowEmptyArchive: true
			}
		}
	}
	post {
		always {
			cleanWs()
		}
	}
}

