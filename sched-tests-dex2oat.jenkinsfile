pipeline {
	agent { label params.NODE }

	parameters {
		string(name: 'NODE', defaultValue: '', description: 'The DUT to run on. Must be Android based DUT.')
		string(name: 'DESCRIPTION', defaultValue: '', description: 'Describe your experiment so that we have a meaningful name for this run to return to')
		string(name: 'ITERATIONS', defaultValue: '10', description: 'Number of iterations to run')
		string(name: 'DELAY', defaultValue: '10', description: 'Time in seconds to wait between each run.')
	}

	environment {
		RUN_DEX2OAT = false
	}

	stages {
		stage('Connect') {
			steps {
				set_description()
				verify_android()
				connect()
				android_wakeup_device()
				verify_params()
			}
		}
		stage('dex2oat of all packages') {
			steps {
				wait_dex2oat()
				start_perfetto("dex2oat")
				run_dex2oat(env.ITERATIONS, env.DELAY)
				stop_perfetto()
			}
			post {
				always {
					wait_dex2oat()
				}
			}
		}
		stage('Generate Plots') {
			steps {
				plot_frequency()
				plot_idle()
				plot_power()
				plot_jank()
			}
		}
		stage('Archive') {
			steps {
				archiveArtifacts artifacts: '*.png', followSymlinks: false
				archiveArtifacts artifacts: '*.perfetto-trace', followSymlinks: false, allowEmptyArchive: true
			}
		}
	}
	post {
		always {
			android_doze_device()
			disconnect()
			cleanWs()
		}
	}
}
