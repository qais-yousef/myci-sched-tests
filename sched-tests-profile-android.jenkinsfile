pipeline {
	agent any

	parameters {
		string(name: 'NODE', defaultValue: '', description: 'The DUT to run on. Must be Android based DUT.')
		string(name: 'DESCRIPTION', defaultValue: '', description: 'Describe your experiment so that we have a meaningful name for this run to return to')
		string(name: 'BRANCH', defaultValue: "${MYCI_BRANCH}", description: 'Which branch to run from? For power users experimenting/developing new changes.')
		string(name: 'ITERATIONS', defaultValue: '3', description: 'Number of iterations to run')
		string(name: 'DELAY', defaultValue: '10', description: 'Time in seconds to wait between each run.')
		string(name: 'QUIET_PERIOD', defaultValue: '1200', description: 'Time in seconds to wait between each _test_ to avoid heating the system.')
	}

	environment {
		MYCI_BRANCH = "${BRANCH}"
	}

	stages {
		stage('Init') {
			steps {
				library "sched-tests-utils@${MYCI_BRANCH}"
				verify_params(!env.QUIET_PERIOD)
				set_description()
			}
		}
		stage('Dex2oat') {
			steps {
				build_android_job('sched-tests-dex2oat', 0, false)
			}
		}
		stage('Speedometer') {
			steps {
				build_android_job('sched-tests-speedometer', params.QUIET_PERIOD, false)
			}
		}
		stage('Speedometer + Dex2oat') {
			steps {
				build_android_job('sched-tests-speedometer', params.QUIET_PERIOD, true)
			}
		}
		stage('PCMark') {
			steps {
				build_android_job('sched-tests-pcmark', params.QUIET_PERIOD, false)
			}
		}
		stage('PCMark + Dex2oat') {
			steps {
				build_android_job('sched-tests-pcmark', params.QUIET_PERIOD, true)
			}
		}
		stage('Geekbench') {
			steps {
				build_android_job('sched-tests-geekbench', params.QUIET_PERIOD, false)
			}
		}
		stage('Archive') {
			steps {
				archiveArtifacts artifacts: '**/*.png', followSymlinks: false, allowEmptyArchive: true
			}
		}
	}
	post {
		always {
			cleanWs()
		}
	}
}
